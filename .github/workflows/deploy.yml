name: Deploy to Cloudflare

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read

env:
  # Enable gzip compression for Pulumi state files
  PULUMI_DIY_BACKEND_GZIP: 'true'
  AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 #v4.2.0
        with:
          version: 10.20.0

      - name: Use Node.js 24.x
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f #v6.1.0
        with:
          node-version: 24.x
          cache: 'pnpm'

      - name: Install packages
        run: pnpm install

      - name: Check formatting
        run: pnpm format:check

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm compile

      - name: Run tests
        run: pnpm test

  build-and-deploy:
    if: ${{ github.event_name != 'pull_request' }}
    concurrency:
      group: deploy-${{ github.repository }}-${{ github.ref }}
      cancel-in-progress: false
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Validate required secrets
        shell: bash
        run: |
          missing=()

          [ -z "${CLOUDFLARE_ACCOUNT_ID}" ] && missing+=(CLOUDFLARE_ACCOUNT_ID)
          [ -z "${CLOUDFLARE_API_TOKEN}" ] && missing+=(CLOUDFLARE_API_TOKEN)
          [ -z "${AWS_ACCESS_KEY_ID}" ] && missing+=(R2_ACCESS_KEY_ID)
          [ -z "${AWS_SECRET_ACCESS_KEY}" ] && missing+=(R2_SECRET_ACCESS_KEY)
          [ -z "${PULUMI_CONFIG_PASSPHRASE}" ] && missing+=(PULUMI_CONFIG_PASSPHRASE)

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required secrets:"
            for key in "${missing[@]}"; do
              echo "- $key"
            done
            exit 1
          fi

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 #v4.2.0
        with:
          version: 10.20.0

      - name: Use Node.js 24.x
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f #v6.1.0
        with:
          node-version: 24.x
          cache: 'pnpm'

      - name: Install packages
        run: pnpm install

      - name: Set project variables
        shell: bash
        run: |
          RAW_SLUG="$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9-]+/-/g' | sed -E 's/^-+|-+$//g' | sed -E 's/-+/-/g')"
          if [ -z "$RAW_SLUG" ]; then
            RAW_SLUG="flarewatch"
          fi

          # Must fit R2 bucket naming limits once "-pulumi-state" is appended.
          MAX_LEN=50
          if [ ${#RAW_SLUG} -gt $MAX_LEN ]; then
            HASH="$(echo -n "$RAW_SLUG" | sha1sum | cut -c1-8)"
            PREFIX_LEN=$((MAX_LEN - 9)) # "-" + 8-char hash
            PREFIX="$(echo -n "${RAW_SLUG:0:$PREFIX_LEN}" | sed -E 's/-+$//')"
            PROJECT_NAME="${PREFIX}-${HASH}"
          else
            PROJECT_NAME="$RAW_SLUG"
          fi
          echo "PROJECT_NAME=$PROJECT_NAME" >> "$GITHUB_ENV"
          echo "PULUMI_BACKEND_URL=s3://$PROJECT_NAME-pulumi-state?endpoint=https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com&region=auto" >> "$GITHUB_ENV"

      - name: Build worker
        run: pnpm worker:build

      - name: Build status page
        run: pnpm run build

      - name: Ensure R2 bucket exists
        shell: bash
        run: |
          set +e
          OUTPUT="$(pnpm -C apps/status-page exec wrangler r2 bucket create "$PROJECT_NAME-pulumi-state" 2>&1)"
          EXIT_CODE="$?"
          set -e

          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "$OUTPUT"
            exit 0
          fi

          if echo "$OUTPUT" | grep -q "code: 10004"; then
            echo "R2 bucket already exists: $PROJECT_NAME-pulumi-state"
            exit 0
          fi

          echo "$OUTPUT"
          exit "$EXIT_CODE"

      - name: Setup Pulumi CLI
        uses: pulumi/actions@8582a9e8cc630786854029b4e09281acd6794b58 # v6.6.1
        with:
          pulumi-version-file: .pulumi.version

      # Pulumi deployment (all resources including status page)
      - name: Deploy with Pulumi
        env:
          FLAREWATCH_PROXY_TOKEN: ${{ secrets.FLAREWATCH_PROXY_TOKEN }}
          FLAREWATCH_STATUS_PAGE_BASIC_AUTH: ${{ secrets.FLAREWATCH_STATUS_PAGE_BASIC_AUTH }}
          FLAREWATCH_ADMIN_BASIC_AUTH: ${{ secrets.FLAREWATCH_ADMIN_BASIC_AUTH }}
        run: |
          pulumi -C infra login "$PULUMI_BACKEND_URL"
          pulumi -C infra stack select production --create
          pulumi -C infra config set accountId "$CLOUDFLARE_ACCOUNT_ID"
          pulumi -C infra config set projectName "$PROJECT_NAME"
          if [ -n "$FLAREWATCH_PROXY_TOKEN" ]; then
            pulumi -C infra config set --secret proxyToken "$FLAREWATCH_PROXY_TOKEN"
          fi
          if [ -n "$FLAREWATCH_STATUS_PAGE_BASIC_AUTH" ]; then
            pulumi -C infra config set --secret statusPageBasicAuth "$FLAREWATCH_STATUS_PAGE_BASIC_AUTH"
          fi
          if [ -n "$FLAREWATCH_ADMIN_BASIC_AUTH" ]; then
            pulumi -C infra config set --secret adminBasicAuth "$FLAREWATCH_ADMIN_BASIC_AUTH"
          fi
          if [ -n "$CUSTOM_DOMAIN" ]; then
            pulumi -C infra config set customDomain "$CUSTOM_DOMAIN"
          fi
          if [ -n "$CUSTOM_DOMAIN_ZONE_ID" ]; then
            pulumi -C infra config set customDomainZoneId "$CUSTOM_DOMAIN_ZONE_ID"
          fi
          pulumi -C infra up --yes
